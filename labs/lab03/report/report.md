---
## Front matter
title: "Отчёт по лабораторной работе 3"
subtitle: "Настройка DHCP-сервера"
author: "Чилеше Лупупа"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию DHCPсервера.

# Выполнение работы

## Конфигурирование DHCP-сервера

### Сохранение конфигурационного файла

Перед внесением изменений была выполнена резервная копия основного конфигурационного файла DHCP-сервера:

cp /etc/kea/kea-dhcp4.conf /etc/kea/kea-dhcp4.conf__$(date -I)

На скриншоте показан результат выполнения команды:

![Резервное копирование конфигурации](Screenshot_1.png){ #fig:101 width=80% }

### Редактирование файла kea-dhcp4.conf

Файл `/etc/kea/kea-dhcp4.conf` был открыт для редактирования. В блоке параметров были внесены следующие изменения.

#### Замена значений domain-name и domain-search

Исходные записи:

{
    "code": 15,
    "data": "example.org"
},
{
    "name": "domain-search",
    "data": "srv.world"
}

были заменены на:

{
    "code": 15,
    "data": "chileshe.net"
},
{
    "name": "domain-search",
    "data": "chileshe.net"
}

Фрагмент редактируемого файла представлен на изображении:

![Редактирование domain-name и domain-search](Screenshot_2.png){ #fig:102 width=80% }

#### Измена параметра domain-name-servers

Значения по умолчанию:

{
    "name": "domain-name-servers",
    "data": "192.0.2.1, 192.0.2.2"
}

были заменены на:

{
    "name": "domain-name-servers",
    "data": "192.168.1.1"
}

#### Настройка подсети

На основе примера в конфигурационном файле добавлена собственная DHCP-сеть:

- подсеть: `192.168.1.0/24`
- диапазон выдаваемых адресов: `192.168.1.30–192.168.1.199`
- шлюз: `192.168.1.1`
- broadcast-адрес выбирается автоматически на основе подсети

Использованный блок:

"subnet4": [
{
    "id": 1,
    "subnet": "192.168.1.0/24",
    "pools": [ { "pool": "192.168.1.30 - 192.168.1.199" } ],
    "option-data": [
        {
            "name": "routers",
            "data": "192.168.1.1"
        }
    ]
}
],

Оставшиеся шаблонные подсети были удалены.

Фрагмент конфигурации показан на скриншоте:

![Настройка подсети DHCP](Screenshot_3.png){ #fig:103 width=80% }

#### Привязка DHCP к интерфейсу eth1

Добавлен блок:

"interfaces-config": {
    "interfaces": [ "eth1" ]
},

### Проверка конфигурации

Валидность файла проверена командой:

kea-dhcp4 -t /etc/kea/kea-dhcp4.conf

На изображении показан результат успешной проверки:

![Проверка конфигурации kea](Screenshot_4.png){ #fig:104 width=80% }

### Перезагрузка конфигурации и включение службы

systemctl --system daemon-reload  
systemctl enable kea-dhcp4.service

## Настройка DNS-зон

### Прямая зона

В конец файла `/var/named/master/fz/chileshe.net` добавлена запись:

dhcp    A    192.168.1.1

Также обновлён серийный номер зоны.

![Редактирование прямой зоны](Screenshot_5.png){ #fig:105 width=80% }

### Обратная зона

В файл `/var/named/master/rz/192.168.1` добавлена запись:

1    PTR    dhcp.chileshe.net.

Серийный номер зоны также обновлён.

![Редактирование обратной зоны](Screenshot_6.png){ #fig:106 width=80% }

### Перезапуск named и проверка работы DNS

systemctl restart named  
ping dhcp.chileshe.net

Результат пинга подтверждает успешное разрешение имени:

![Проверка разрешения имени DHCP](Screenshot_7.png){ #fig:107 width=80% }

### Настройка межсетевого экрана и SELinux

Для разрешения работы DHCP были добавлены необходимые правила:

firewall-cmd --add-service=dhcp  
firewall-cmd --add-service=dhcp --permanent

Далее восстановлены контексты SELinux:

restorecon -vR /etc  
restorecon -vR /var/named  
restorecon -vR /var/lib/kea/

Результат операций:

![Firewall и restorecon](Screenshot_8.png){ #fig:108 width=80% }

### Запуск DHCP-сервера

Во вспомогательном терминале был включён мониторинг системных сообщений:

tail -f /var/log/messages

В основном терминале произведён запуск службы:

systemctl start kea-dhcp4.service


## Анализ работы DHCP-сервера

### Настройка маршрутизации клиента

Перед запуском виртуальной машины **client** был создан файл `01-routing.sh` в каталоге `vagrant/provision/client`.  
В него был внесён скрипт, который перенастраивает NetworkManager так, чтобы весь исходящий трафик по умолчанию шёл через интерфейс `eth1`.  
Этот скрипт выполняет следующие действия:

- назначает для соединения *eth1* шлюз `192.168.1.1`;
- активирует соединение *eth1*;
- запрещает использовать *eth0* как маршрут по умолчанию для IPv4 и IPv6;
- перезапускает соединение *eth0*.

Фрагмент скрипта:

![Скрипт маршрутизации клиента](Screenshot_9.png){ #fig:201 width=80% }

Скрипт был подключён в секции конфигурации клиента внутри `Vagrantfile`, после чего клиентская машина была поднята и провиженинг выполнен.

### Анализ сетевых интерфейсов на клиентской машине

После загрузки клиентской виртуальной машины и применения сетевых настроек был выполнен просмотр интерфейсов командой `ifconfig`.

Результат:

![Информация об интерфейсах клиента](Screenshot_10.png){ #fig:202 width=80% }

Разбор данных по интерфейсу `eth1`:

- интерфейс активирован, работает в режиме **UP, BROADCAST, RUNNING, MULTICAST**;
- IP-адрес: `192.168.1.30`;
- маска сети: `255.255.255.0`;
- broadcast-адрес: `192.168.1.255`;
- MAC-адрес: `08:00:27:a6:73:3b`;
- интерфейс передаёт и принимает пакеты без ошибок, что подтверждает корректную работу полученного от DHCP параметров.

Интерфейс `lo` представляет собой стандартный интерфейс loopback, используется для локальных обращений к машине.

### Анализ файла /var/lib/kea/kea-leases4.csv

На сервере был просмотрен файл с информацией о выданных DHCP-адресах.  
Файл отражает каждую запись о выдаче адреса клиентам.

![Содержимое файла kea-leases4.csv](Screenshot_11.png){ #fig:203 width=80% }

Разбор строк файла:

1. **address** — выданный клиенту IPv4-адрес:  
   `192.168.1.30`

2. **hwaddr** — MAC-адрес клиента:  
   `08:00:27:a6:73:3b`  
   Этот адрес совпадает с MAC-адресом интерфейса `eth1` на клиентской машине.

3. **client_id** — идентификатор клиента:  
   `01:08:00:27:a6:73:3b`  
   Здесь *01* означает идентификатор Ethernet, далее идёт MAC-адрес.

4. **valid_lifetime** — время жизни аренды в секундах:  
   `3600` (1 час)

5. **expire** — время истечения аренды (UNIX timestamp):  
   значения отличаются для разных аренд.

6. **subnet_id** — идентификатор подсети, из которой выделен адрес:  
   `1`  
   Это соответствует идентификатору, заданному в конфигурации DHCP.

7. **fqdn_fwd** и **fqdn_rev** — управление прямой и обратной DNS-записями:  
   значение `1` означает включённое обновление.

8. **hostname** — имя клиента:  
   указывается как `client`

9. **state** — состояние аренды:  
   `0` означает *active*.

10. **user_context** — дополнительные данные пользователя, отсутствуют (пусто).

11. **pool_id** — идентификатор пула, из которого выдан адрес:  
    `0`  
    Так как в конфигурации задан только один пул.

Все записи подтверждают, что DHCP-сервер корректно выдал адрес клиентской машине и обновил аренду несколько раз, что отражено в файле несколькими строками.

## Настройка обновления DNS-зоны

### Создание и подключение TSIG-ключа для динамического обновления зон

### Генерация ключа

Для обеспечения безопасного обновления DNS-записей был создан каталог для хранения ключей и сгенерирован TSIG-ключ алгоритмом **HMAC-SHA512**.  

Результат выполнения команд и содержимое ключа:

![Генерация TSIG-ключа](Screenshot_12.png){ #fig:301 width=80% }

После генерации ключ был помещён в файл `/etc/named/keys/dhcp_updater.key` и получил корректные права доступа, принадлежащие пользователю и группе **named**.

### Подключение ключа в конфигурацию named

В файл `/etc/named.conf` был добавлен include-блок: `include "/etc/named/keys/dhcp_updater.key";`


Это позволяет серверу BIND9 использовать TSIG-ключ для проверки авторизованных обновлений зон.

Фрагмент конфигурации:

![Вставка ключа в named.conf](Screenshot_13.png){ #fig:302 width=80% }

### Разрешение обновления прямой и обратной зон

Файлы зон были скорректированы так, чтобы DHCP-сервер мог автоматически добавлять и изменять записи A/PTR.  

В прямой зоне:

![Настройка update-policy для прямой зоны](Screenshot_14.png){ #fig:303 width=80% }

В обратной зоне:

![Настройка update-policy для обратной зоны](Screenshot_15.png){ #fig:304 width=80% }

Использована директива: `grant DHCP_UPDATER wildcard *.chileshe.net A DHCID;`

а также аналогичная для PTR-записей в обратной зоне.

После внесения изменений конфигурация прошла успешную проверку и DNS-сервер был перезапущен.

### Создание ключа для Kea DHCP

Для взаимодействия DHCP-сервера Kea с BIND была создана JSON-версия TSIG-ключа:

![Конфигурация tsig-keys.json](Screenshot_16.png){ #fig:305 width=80% }

Файл получил корректные права и владельца (`kea:kea`).

### Настройка Kea DHCP-DDNS

В файл `/etc/kea/kea-dhcp-ddns.conf` были внесены параметры:

- IP-адрес и порт локального DDNS-сервиса Kea;
- подключение файла ключей;
- настройки **forward-ddns** и **reverse-ddns**, указывающие имя зоны, TSIG-ключ и DNS-сервер BIND;
- логирование.

Фрагмент конфигурации:

![Конфигурация kea-dhcp-ddns.conf](Screenshot_17.png){ #fig:306 width=80% }

После проверки синтаксиса служба была включена и успешно запущена:

![Статус службы Kea DDNS](Screenshot_18.png){ #fig:307 width=80% }


### Разрешение DHCP-сервису обновлять DNS-записи

В основной конфигурационный файл DHCP `/etc/kea/kea-dhcp4.conf` были внесены параметры:

- включение DDNS-обновлений;
- указание доменного суффикса (`chileshe.net`);
- принудительное переопределение данных от клиента.

Фрагмент файла:

![dhcp4 конфигурация с DDNS параметрами](Screenshot_19.png){ #fig:308 width=80% }

Файл успешно прошёл проверку, и служба DHCP была перезапущена:

![Статус Kea DHCP после перезапуска](Screenshot_20.png){ #fig:309 width=80% }

# Анализ работы DHCP-сервера после настройки обновления DNS-зоны

После настройки DDNS на виртуальной машине **client** была выполнена команда: `dig @192.168.1.1 client.chileshe.net`

Результат:

![Результат dig](Screenshot_21.png){ #fig:401 width=80% }

Построчный разбор:

- **DiG 9.18.33 @192.168.1.1 client.chileshe.net** — используется утилита dig, запрос отправлен DNS-серверу по адресу 192.168.1.1, запрашивается запись `client.chileshe.net`.
- **(1 server found)** — найден один DNS-сервер.
- **Got answer** — ответ получен успешно.
- **opcode: QUERY, status: NOERROR** — тип операции: запрос; ошибок нет.
- **QUERY: 1, ANSWER: 1** — один вопрос и один найденный ответ.
- **client.chileshe.net. IN A** — запрашивалась A-запись.
- **ANSWER SECTION** — секция с ответом:
  - **client.chileshe.net. 1200 IN A 192.168.1.30**  
    DNS-сервер сообщает, что у узла client.chileshe.net IP-адрес: **192.168.1.30**, выданный DHCP.
- **SERVER: 192.168.1.1** — отвечает локальный DNS-сервер.
- **QUERY TIME: 1 msec** — время ответа минимально.
- **MSG SIZE rcvd: 92** — размер полученного DNS-пакета.

Это подтверждает корректную работу DDNS-обновлений:  
**DHCP-сервер автоматически создал запись A в прямой зоне.**

## Внесение изменений в настройки внутреннего окружения виртуальной машины

В каталоге `/vagrant/provision/server/` был создан сценарий:

![dhcp.sh](Screenshot_22.png){ #fig:402 width=80% }

# Вывод

В ходе выполнения работы была настроена комплексная система автоматической выдачи сетевых параметров и динамического обновления DNS-записей. DHCP-сервер Kea был интегрирован с DNS-сервером Bind9 посредством механизма TSIG-подписей, что позволило обеспечить безопасное и корректное обновление прямой и обратной DNS-зоны при подключении новых узлов. Конфигурационные файлы DHCP, DDNS и DNS были адаптированы под заданную сетевую архитектуру, а необходимые службы успешно прошли проверку и были запущены.

После настройки клиентская виртуальная машина автоматически получила IP-адрес от DHCP-сервера, а соответствующие A- и PTR-записи были добавлены в зоны chileshe.net и 1.168.192.in-addr.arpa. Проверка с помощью утилиты dig показала корректное разрешение имени клиента, что подтвердило работоспособность DDNS-механизма. Дополнительно была выполнена подготовка внутренних конфигураций Vagrant, позволяющая полностью автоматизировать развёртывание сервера DHCP и DNS в дальнейшем. Все цели лабораторной работы были достигнуты, а функциональность сетевой инфраструктуры подтверждена тестированием.

# Контрольные вопросы

**1. В каких файлах хранятся настройки сетевых подключений?**  
Настройки сетевых подключений в Linux обычно хранятся в каталоге `/etc/sysconfig/network-scripts/` (для систем семейства RHEL, Rocky, CentOS), где каждый интерфейс представлен отдельным файлом вида `ifcfg-eth0`, `ifcfg-eth1` и т. д.  
В современных системах, использующих NetworkManager, конфигурации могут храниться в каталоге `/etc/NetworkManager/system-connections/` в формате keyfile. Эти файлы определяют параметры IP-адресации, шлюз, DNS-серверы, маршруты и тип соединения.

**2. За что отвечает протокол DHCP?**  
DHCP (Dynamic Host Configuration Protocol) отвечает за автоматическую выдачу сетевых параметров клиентским устройствам. Он позволяет компьютерам получать IP-адрес, маску подсети, gateway, DNS-серверы и другие параметры без ручной настройки.

**3. Поясните принцип работы протокола DHCP. Какими сообщениями обмениваются клиент и сервер?**  
Работа DHCP основана на обмене четырьмя основными сообщениями:
- **DHCPDISCOVER** — клиент ищет DHCP-сервер в сети и отправляет широковещательный запрос.  
- **DHCPOFFER** — сервер откликается и предлагает свободный IP-адрес.  
- **DHCPREQUEST** — клиент принимает одно из предложений и запрашивает конкретный адрес у сервера.  
- **DHCPACK** — сервер подтверждает выдачу адреса и передает клиенту полную конфигурацию.  
Этот процесс обеспечивает автоматическую и согласованную настройку сетевых параметров клиентских устройств.

**4. В каких файлах обычно находятся настройки DHCP-сервера? За что отвечает каждый?**  
В DHCP-сервере Kea настройки располагаются в каталоге `/etc/kea/`. Основные файлы:
- **kea-dhcp4.conf** — основная конфигурация DHCPv4: параметры подсетей, диапазоны выдачи адресов, опции клиентов.  
- **kea-dhcp-ddns.conf** — настройки динамического обновления DNS (DDNS).  
- **tsig-keys.json** — хранит TSIG-ключи для авторизованных обновлений зон DNS.  
- **lease-файлы (например, kea-leases4.csv)** — таблицы активных аренд (lease), содержащие информацию о выданных IP-адресах.

**5. Что такое DDNS? Для чего применяется DDNS?**  
DDNS (Dynamic DNS) — механизм динамического обновления DNS-зон.  
Он используется, чтобы автоматически регистрировать A- и PTR-записи для устройств, получающих адреса по DHCP. Например, когда клиент получил IP-адрес, сервер автоматически добавляет записи вида:
- client.example.net → 192.168.1.10 (A-запись)
- 10.1.168.192.in-addr.arpa → client.example.net (PTR-запись)  
DDNS обеспечивает актуальность DNS при динамической адресации устройств.

**6. Какую информацию можно получить с помощью ifconfig? Приведите примеры с опциями.**  
Утилита `ifconfig` позволяет просматривать и настраивать сетевые интерфейсы. Она показывает:
- IP-адрес интерфейса,
- маску подсети,
- MAC-адрес,
- статистику переданных и полученных пакетов,
- состояние интерфейса (UP/DOWN).

Примеры:
- `ifconfig` — вывести сведения обо всех активных интерфейсах.  
- `ifconfig eth1` — показать информацию только об интерфейсе eth1.  
- `ifconfig eth1 down` — отключить интерфейс.  
- `ifconfig eth1 mtu 1400` — изменить MTU интерфейса.

**7. Какую информацию можно получить, используя ping? Приведите примеры.**  
Утилита `ping` используется для проверки доступности узла и диагностики сетевой задержки. Она показывает:
- время отклика до узла (latency),
- потерю пакетов,
- IP-адрес удалённого хоста,
- работу маршрутизации.

Примеры:
- `ping 8.8.8.8` — проверить доступность DNS Google.  
- `ping -c 4 192.168.1.1` — отправить 4 ICMP-пакета.  
- `ping -s 200 192.168.1.1` — отправить пакеты размером 200 байт.  
- `ping -i 0.2 host` — посылать пакеты каждые 0.2 секунды.

