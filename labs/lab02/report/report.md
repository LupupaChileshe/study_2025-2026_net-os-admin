---
## Front matter
title: "Отчёт по лабораторной работе 2"
subtitle: "Настройка DNS-сервера"
author: "Чилеше Лупупа"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию DNSсервера, усвоение принципов работы системы доменных имён.

# Выполнение работы

## Первичная проверка DNS-разрешения

После установки пакетов bind и bind-utils была выполнена проверка DNS-разрешения для домена `www.yandex.ru` с помощью утилиты dig.

На изображении показан результат выполнения команды и содержимое секций HEADER, QUESTION и ANSWER, где отображены три A-записи домена:

![Результат выполнения dig www.yandex.ru](Screenshot_1.png){ #fig:001 width=80% }

Полученные IP-адреса:
- 77.88.44.55  
- 77.88.55.88  
- 5.255.255.77  

Также отображены параметры времени выполнения и адрес DNS-сервера, ответившего на запрос.

## Запуск DNS-сервера и анализ результата

После запуска службы named и включения её в автозагрузку были выполнены два DNS-запроса: обычный и направленный на локальный DNS-сервер.

![Сравнение dig и dig @127.0.0.1](Screenshot_2.png){ #fig:002 width=80% }

Отличия:

- Первый запрос использует внешний DNS-сервер.
- Второй — направлен на локальный сервер (`127.0.0.1`).  
  Первоначально возникала ошибка связи, так как служба была в процессе настройки. После корректной конфигурации локальный сервер начал выдавать ответы.

## Настройка DNS-сервера по умолчанию для интерфейса eth0

Внутренний DNS-сервер был назначен основным для всех запросов хоста.  
Для этого параметры соединения eth0 были изменены через NetworkManager.

![Настройка NetworkManager](Screenshot_3.png){ #fig:003 width=80% }

Внесённые изменения:
- удалён параметр авто-DNS
- отключено автоматическое получение DNS
- установлен локальный DNS-сервер: `127.0.0.1`

После перезапуска NetworkManager файл `/etc/resolv.conf` стал использовать локальный адрес.

## Конфигурирование файла named.conf

Для направления DNS-запросов от всех узлов внутренней сети были изменены параметры в `/etc/named.conf`.

![Фрагмент файла named.conf](Screenshot_4.png){ #fig:004 width=80% }

Изменено:

- строка `listen-on port 53 { 127.0.0.1; any; };`  
  позволяет серверу слушать все интерфейсы.

- строка `allow-query { localhost; 192.168.0.0/16; };`  
  разрешает DNS-запросы от внутренних сетей.

Эти параметры позволяют сервису named принимать и обрабатывать запросы от всех узлов сети.

## Разрешение работы DNS-сервера через межсетевой экран

Для корректной работы DNS-сервера были разрешены необходимые службы в firewall.

## Проверка активности службы DNS

Для подтверждения того, что named слушает порт 53, был выполнен анализ UDP-портов.  
Результаты отображены на изображении.

![Результат lsof | grep UDP](Screenshot_5.png){ #fig:005 width=95% }

На экране видно:
- множество открытых UDP-сокетов процесса named
- порт domain (53) прослушивается
- присутствуют записи для IPv4 и IPv6

Это подтверждает корректную работу кэширующего DNS-сервера.

## Подключение файла зон

Для начала был скопирован шаблон `named.rfc1912.zones` в каталог `/etc/named` и переименован согласно варианту. Затем файл был подключён в конфигурации BIND через директиву `include`.

После подключения в конфигурации сервера стала доступна собственная зона, предназначенная для дальнейшего редактирования.

## Настройка файла user.net с прямой и обратной зоной

В файле описания зон были удалены стандартные записи и добавлены две собственные зоны:

- прямая зона домена `chileshe.net`
- обратная зона `1.168.192.in-addr.arpa`

Соответствующий фрагмент файла выглядит следующим образом:

![Файл описания прямой и обратной зон](Screenshot_6.png){ #fig:006 width=80% }

## Создание каталогов для файлов зон

В каталоге `/var/named` были созданы подкаталоги:

- `master/fz` — для файлов прямой зоны  
- `master/rz` — для файлов обратной зоны  

Они предназначены для хранения пользовательских файлов зоны, созданных на основе шаблонов.

## Настройка прямой зоны

Шаблон прямой зоны был скопирован в каталог `master/fz` и переименован. Далее в него были внесены необходимые изменения:

- заменено имя сервера на `server.chileshe.net.`
- указан корректный серийный номер
- изменён IP-адрес на `192.168.1.1`
- установлена директива `$ORIGIN chileshe.net.`
- добавлены A-записи для серверов

Конечное содержимое прямой зоны:

![Файл прямой зоны](Screenshot_7.png){ #fig:007 width=80% }

## Настройка обратной зоны

Шаблон обратной зоны был скопирован в каталог `master/rz` и переименован в `192.168.1`. Далее были внесены изменения:

- обновлён SOA-блок  
- указан IP-адрес сервера  
- добавлены PTR-записи для правильного обратного отображения IP → имя  

Готовый файл обратной зоны имеет следующий вид:

![Файл обратной зоны](Screenshot_8.png){ #fig:008 width=80% }

## Настройка прав доступа и контекстов SELinux

Для корректной работы BIND были исправлены владельцы каталогов `/etc/named` и `/var/named`.  
После изменения прав были восстановлены SELinux-контексты, необходимые для работы службы.

Также проверены параметры SELinux, связанные с `named`, и разрешена запись в мастер-зоны при необходимости.

## Перезапуск службы и проверка в логах

После завершения настройки был выполнен перезапуск службы DNS.  
В логе (`journalctl -x -f`) проверено отсутствие ошибок. На скриншоте показан фрагмент команд и проверок:

![Настройка SELinux и перезапуск named](Screenshot_9.png){ #fig:009 width=80% }

Система успешно приняла новые файлы зон, а DNS-сервер был перезапущен без ошибок.

## Проверка прямой зоны

После завершения конфигурации прямой зоны было выполнено тестирование с помощью утилиты `dig`.  
Запрос к записи `ns.chileshe.net` был успешно обработан локальным DNS-сервером:

![Проверка A-записи ns.chileshe.net](Screenshot_10.png){ #fig:010 width=80% }

В ответе указано:
- статус `NOERROR`  
- одна A-запись
- IP-адрес: `192.168.1.1`  
- истина: данные получены от локального сервера `127.0.0.1#53`

Это подтверждает корректность настройки прямой зоны.

## Проверка зоны домена и обратной зоны

Также были выполнены дополнительные проверки с использованием команды `host`.  
Они подтверждают корректность обработки NS-, SOA-, A- и PTR-записей.

![Проверка прямой и обратной зоны](Screenshot_11.png){ #fig:011 width=80% }

Полученные результаты:

- `host -l chileshe.net` корректно перечисляет все записи зоны  
- `host -t any chileshe.net` отображает:
  - SOA-запись зоны  
  - NS-записи  
  - A-запись сервера  
- `host -t PTR 192.168.1.1` возвращает название хоста:
  - `server.chileshe.net`
  - `ns.chileshe.net`

Обратное разрешение работает корректно.

## Подготовка каталога provisioning

Для автоматизации конфигурации DNS в среде Vagrant были созданы каталоги в дереве `/vagrant/provision/server/dns/`:

![Создание каталогов и копирование файлов](Screenshot_12.png){ #fig:012 width=90% }

В каталоги были скопированы:
- файл `named.conf`
- содержимое `/etc/named/`
- файлы прямой и обратной зоны из `/var/named/master/`

Эти данные будут использоваться дальше для автоматической конфигурации DNS при подъёме окружения.

## Создание скрипта dns.sh

В каталоге `/vagrant/provision/server` был создан исполняемый файл `dns.sh`, содержащий команды:

- установка пакетов BIND
- копирование конфигурационных файлов
- установка необходимых прав
- восстановление SELinux-контекстов
- настройка firewall
- разрешение SELinux-политик
- изменение системного DNS на 127.0.0.1
- перезапуск NetworkManager
- запуск службы named

Готовый файл выглядит следующим образом:

![Содержимое dns.sh](Screenshot_13.png){ #fig:013 width=80% }

Скрипт полностью автоматизирует настройку DNS-сервера при развёртывании виртуальной машины.

# Вывод

В ходе работы был развернут и настроен полноценный DNS-сервер на базе BIND, включающий кэширующие и авторитативные функции. Созданы прямые и обратные зоны, настроены файлы конфигурации, исправлены права доступа и восстановлены контексты SELinux. Проведены проверки работы сервера с помощью утилит dig и host, подтверждающие корректность разрешения имён и обратного отображения IP-адресов. Создано автоматизированное окружение provisioning для повторного развёртывания DNS-сервера в среде Vagrant. Все этапы выполнены успешно, что демонстрирует правильную настройку инфраструктуры и работоспособность DNS-системы.

# Контрольные вопросы

**1. Что такое DNS?**  
DNS — это распределённая система доменных имён, предназначенная для преобразования человекочитаемых доменов (например, `example.com`) в IP-адреса и обратно.

**2. Каково назначение кэширующего DNS-сервера?**  
Кэширующий DNS-сервер обрабатывает запросы клиентов и сохраняет полученные ответы в кэше, ускоряя последующие обращения к тем же доменам и уменьшая нагрузку на внешние DNS-серверы.

**3. Чем отличается прямая DNS-зона от обратной?**  
Прямая зона сопоставляет доменные имена с IP-адресами, а обратная зона осуществляет обратное преобразование — IP-адресов в доменные имена.

**4. В каких каталогах и файлах располагаются настройки DNS-сервера? Кратко охарактеризуйте, за что они отвечают.**  
Основные каталоги:
- `/etc/named.conf` — главный конфигурационный файл BIND.  
- `/etc/named/` — дополнительные конфигурационные файлы зон.  
- `/var/named/` — файлы прямых и обратных зон.  
Эти файлы определяют параметры работы сервера, пути к зонам и правила доступа.

**5. Что указывается в файле resolv.conf?**  
В `resolv.conf` задаются DNS-серверы, которые будут использоваться системой для разрешения доменных имён.

**6. Какие типы записи описания ресурсов есть в DNS и для чего они используются?**  
Основные типы:
- **A** — привязка домена к IPv4-адресу.  
- **AAAA** — привязка к IPv6.  
- **NS** — указание серверов зоны.  
- **CNAME** — алиас доменного имени.  
- **MX** — почтовые серверы домена.  
- **PTR** — обратное отображение IP → домен.  
- **SOA** — стартовая запись зоны с параметрами обновления.

**7. Для чего используется домен in-addr.arpa?**  
Он используется для организации обратного DNS-разрешения (IP → доменное имя).

**8. Для чего нужен демон named?**  
`named` — это основной процесс BIND, обеспечивающий обработку DNS-запросов, ведение зон и взаимодействие с другими серверами.

**9. В чём заключаются основные функции slave-сервера и master-сервера?**  
- **Master** хранит оригинальные файлы зоны.  
- **Slave** получает их по механизму zone transfer и использует для распределения нагрузки и отказоустойчивости.

**10. Какие параметры отвечают за время обновления зоны?**  
Параметры в SOA-записи:
- **serial** — версия зоны.  
- **refresh** — частота проверки обновлений slave-сервером.  
- **retry** — время повторной попытки подключения.  
- **expire** — время, после которого данные считаются недействительными.  
- **minimum** — время кэширования отрицательных ответов.

**11. Как обеспечить защиту зоны от скачивания и просмотра?**  
Ограничить доступ через директивы `allow-transfer` и `allow-query`, разрешив работу только доверенным серверам.

**12. Какая запись RR применяется при создании почтовых серверов?**  
Для почтовых серверов используется запись **MX**.

**13. Как протестировать работу сервера доменных имён?**  
Используются утилиты:
- `dig`  
- `host`  
- `nslookup`  
Они позволяют выполнять прямые и обратные DNS-запросы.

**14. Как запустить, перезапустить или остановить какую-либо службу в системе?**  
Через systemd:
- `systemctl start <service>`  
- `systemctl restart <service>`  
- `systemctl stop <service>`

**15. Как посмотреть отладочную информацию при запуске какого-либо сервиса или службы?**  
Через вывод журнала:
- `journalctl -xe`  
- `systemctl status <service>`

**16. Где хранится отладочная информация по работе системы и служб? Как её посмотреть?**  
Системные журналы находятся в `journalctl`.  
Просмотр:
- `journalctl -x -f` — потоковое отображение лога.

**17. Как посмотреть, какие файлы использует в своей работе тот или иной процесс? Приведите несколько примеров.**  
Через `lsof`:
- `lsof -p <PID>`  
- `lsof | grep named`  
- `lsof -i :53`

**18. Приведите несколько примеров по изменению сетевого соединения при помощи командного интерфейса nmcli.**  
- `nmcli connection show` — список соединений  
- `nmcli connection edit eth0` — редактирование соединения  
- `nmcli connection modify eth0 ipv4.dns 8.8.8.8`  
- `nmcli device up eth0` — активация интерфейса

**19. Что такое SELinux?**  
SELinux — подсистема контроля доступа, обеспечивающаяMandatory Access Control (MAC) в Linux.

**20. Что такое контекст (метка) SELinux?**  
Контекст определяет права доступа процесса или файла и используется системой для принятия решений по безопасности.

**21. Как восстановить контекст SELinux после внесения изменений в конфигурационные файлы?**  
Команда:
- `restorecon -vR <path>`

**22. Как создать разрешающие правила политики SELinux из файлов журналов, содержащих сообщения о запрете операций?**  
С помощью утилит:
- `audit2allow` — генерация политик по логам  
- `audit2why` — объяснение причин отказов

**23. Что такое булевый переключатель в SELinux?**  
Это параметр, включающий или отключающий конкретные функции SELinux без изменения политик.

**24. Как посмотреть список переключателей SELinux и их состояние?**  
Командой:
- `getsebool -a`

**25. Как изменить значение переключателя SELinux?**  
Через команду:
- `setsebool <switch> on|off`  
Для постоянного изменения:
- `setsebool -P <switch> on|off`
